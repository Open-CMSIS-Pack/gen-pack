#
# Open-CMSIS-Pack gen-pack Bash library
#
# Copyright (c) 2025 Arm Limited. All rights reserved.
#
# Provided as-is without warranty under Apache 2.0 License
# SPDX-License-Identifier: Apache-2.0
#

#
# Launch local HTTP server
#
# Requires 
#  - python3 
#  - http.server module
#
# Usage: start_http_server [<port>] [<dir>] [<pid>]
#   <port>  Port number to listen on, defaults to 8080
#   <dir>   Directory to serve, defaults to '.'
#   <pid>   Variable to store the PID of the server process
#
start_http_server() {
  local port=${1:-8080}
  local dir=${2:-.}
  local -n outvar=${3:pid}

  echo "Starting HTTP server on port ${port}, serving directory '${dir}'"
  python3 -m http.server "${port}" --directory "${dir}" &
  # shellcheck disable=SC2034
  outvar=$!

  until curl -sSf http://localhost:${port} 1> /dev/null 2>&1; do
    echo "Waiting for server..."
    sleep 2

    if ! ps -p "${outvar}" > /dev/null; then
      echo "ERROR: Failed to start HTTP server" >&2
      return 1
    fi
  done
}

#
# Stop HTTP server
#
# Usage: stop_http_server <pid>
#   <pid>  PID of the server process
#
stop_http_server() {
  echo "Stopping HTTP server with PID ${1}"
  if ps -p "${1}" > /dev/null; then
    kill -s TERM "${1}"
    sleep 1
  fi
  if ps -p "${1}" > /dev/null; then
    kill -s KILL "${1}"
  fi
}